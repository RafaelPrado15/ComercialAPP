{% extends 'base.html' %}

{% block title %}Pradolux IA - Chatbot{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <div>
            <h2 class="fw-bold text-pradolux mb-0"><i class="bi bi-robot"></i> Assistente IA</h2>
            <p class="text-muted mb-0">Tire suas dúvidas e consulte informações com nosso assistente virtual.</p>
        </div>
        <a href="{{ url_for('menu') }}" class="btn btn-outline-secondary">Voltar</a>
    </div>
</div>

<div class="card shadow border-0" style="height: 70vh; border-radius: 15px;">
    <div class="card-body p-0 d-flex flex-column">
        <!-- Chat Header -->
        <div class="p-3 border-bottom bg-light d-flex align-items-center rounded-top-4">
            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3"
                style="width: 45px; height: 45px;">
                <i class="bi bi-stars fs-4"></i>
            </div>
            <div>
                <h6 class="mb-0 fw-bold text-dark">Pradolux Assistant</h6>
                <small class="text-success"><i class="bi bi-circle-fill" style="font-size: 8px;"></i> Online</small>
            </div>
        </div>

        <!-- Messages Container -->
        <div id="messages-container" class="flex-grow-1 p-4" style="overflow-y: auto; background-color: #f8f9fa;">

            <!-- Welcome Message -->
            <div class="d-flex flex-row justify-content-start mb-3">
                <div class="bg-white p-3 rounded-3 shadow-sm border" style="max-width: 80%;">
                    <p class="mb-0">Olá! Sou o assistente virtual da Pradolux. Como posso ajudar com seus pedidos ou
                        notas hoje?</p>
                </div>
            </div>

        </div>

        <!-- Input Area -->
        <div class="p-3 border-top bg-white rounded-bottom-4">
            <div class="input-group">
                <input type="text" id="chat-input" class="form-control form-control-lg border-0 bg-light"
                    placeholder="Digite sua mensagem..." aria-label="Digite sua mensagem...">
                <button class="btn btn-primary px-4" type="button" id="send-btn"><i
                        class="bi bi-send-fill"></i></button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const input = document.getElementById('chat-input');
        const sendBtn = document.getElementById('send-btn');
        const container = document.getElementById('messages-container');

        // Function to add message to UI
        function addMessage(text, isUser = false) {
            const div = document.createElement('div');
            div.className = `d-flex flex-row justify-content-${isUser ? 'end' : 'start'} mb-3`;

            const bubble = document.createElement('div');
            bubble.className = isUser
                ? 'bg-primary text-white p-3 rounded-3 shadow-sm'
                : 'bg-white p-3 rounded-3 shadow-sm border';
            bubble.style.maxWidth = '80%';
            bubble.style.whiteSpace = 'pre-wrap'; // Preserve newlines
            bubble.innerText = text; // Safe text insertion

            div.appendChild(bubble);
            container.appendChild(div);

            // Auto scroll
            container.scrollTop = container.scrollHeight;
        }

        // Send Message Function
        async function sendMessage() {
            const text = input.value.trim();
            if (!text) return;

            // 1. Add User Message
            addMessage(text, true);
            input.value = '';
            input.disabled = true;
            sendBtn.disabled = true;

            // 2. Add Loading Indicator
            const loadingId = 'loading-' + Date.now();
            const loadingDiv = document.createElement('div');
            loadingDiv.id = loadingId;
            loadingDiv.className = 'd-flex flex-row justify-content-start mb-3';
            loadingDiv.innerHTML = `
                <div class="bg-white p-3 rounded-3 shadow-sm border">
                    <div class="spinner-grow spinner-grow-sm text-primary" role="status"></div>
                    <div class="spinner-grow spinner-grow-sm text-primary" role="status"></div>
                    <div class="spinner-grow spinner-grow-sm text-primary" role="status"></div>
                </div>
            `;
            container.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;

            try {
                // 3. Send to Flask Proxy
                const response = await fetch("{{ url_for('chat_send') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });

                // Remove Loading
                document.getElementById(loadingId).remove();

                if (response.ok) {
                    const data = await response.json();

                    // Display Bot Response
                    // Expecting { text: "..." } from backend
                    if (data.text) {
                        addMessage(data.text);
                    } else if (data.reply) {
                        addMessage(data.reply);
                    } else {
                        addMessage("Recebi uma resposta vazia do servidor.");
                    }

                } else {
                    addMessage("Erro de comunicação com o servidor.");
                }

            } catch (error) {
                document.getElementById(loadingId)?.remove();
                addMessage("Erro ao enviar mensagem: " + error);
                console.error(error);
            } finally {
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }

        // Event Listeners
        sendBtn.addEventListener('click', sendMessage);
        input.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMessage();
        });
    });
</script>
{% endblock %}